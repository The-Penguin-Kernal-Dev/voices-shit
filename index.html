<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI-Powered Voice Avatar</title>
<style>
  :root {
    --primary-color: #00ff88;
    --background-color: #1a1a1a;
  }

  body {
    margin: 0;
    overflow: hidden;
    background: var(--background-color);
    font-family: Arial, sans-serif;
  }

  #container {
    position: relative;
    width: 100vw;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  #visualization {
    position: absolute;
    width: 100%;
    height: 100%;
  }

  .control-panel {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    padding: 15px;
    border-radius: 10px;
    color: white;
    backdrop-filter: blur(5px);
  }

  .progress-ring {
    position: absolute;
    width: 110%;
    height: 110%;
    stroke-width: 2;
    fill: none;
    stroke: var(--primary-color);
    opacity: 0.3;
  }
</style>
</head>
<body>
<div id="container">
  <canvas id="visualization"></canvas>
  <div class="control-panel">
    <h3>Voice Controls</h3>
    <label>Sensitivity: <input type="range" id="sensitivity" min="0" max="1" step="0.1" value="0.5"></label>
    <div id="status">Initializing...</div>
  </div>
  <svg class="progress-ring">
    <circle id="progressCircle" cx="50%" cy="50%" r="45%"/>
  </svg>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.5.7/dist/speech-commands.min.js"></script>

<script>
const VOICE_PARAMS = {
  SMOOTHING: 0.92,
  MIN_DURATION: 150,
  VOLUME_MULTIPLIER: 2.5
};

class VoiceAvatar {
  constructor() {
    this.initThreeJS();
    this.initAudio();
    this.loadModel();
    this.setupControls();
    this.lastUpdate = 0;
    this.currentVolume = 0;
    this.isSpeaking = false;
  }

  initThreeJS() {
    this.scene = new THREE.Scene();
    this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    this.renderer = new THREE.WebGLRenderer({ antialias: true, canvas: document.querySelector('#visualization') });
    this.renderer.setSize(window.innerWidth, window.innerHeight);
    this.renderer.setPixelRatio(window.devicePixelRatio);
    this.camera.position.z = 2;
  }

  async loadModel() {
    const loader = new THREE.GLTFLoader();
    this.model = await loader.loadAsync('https://cdn.glitch.global/3d-models/robot-avatar.glb');
    this.avatar = this.model.scene;
    this.scene.add(this.avatar);
    this.morphTargets = this.avatar.children[0].morphTargetDictionary;
    this.initialMorph = this.avatar.children[0].morphTargetInfluences;
  }

  async initAudio() {
    this.recognizer = speechCommands.create('BROWSER_FFT');
    await this.recognizer.ensureModelLoaded();
    
    this.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    this.audioContext = new AudioContext();
    this.analyser = this.audioContext.createAnalyser();
    this.analyser.fftSize = 2048;
    
    const source = this.audioContext.createMediaStreamSource(this.stream);
    source.connect(this.analyser);
    
    this.startAnalysis();
  }

  startAnalysis() {
    this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
    this.analysisWorker = new Worker('audio-processor.js');
    
    this.analysisWorker.onmessage = ({ data }) => {
      this.currentVolume = data.volume;
      this.updateVisuals(data);
      this.detectSpeech(data);
    };

    const process = () => {
      this.analyser.getByteFrequencyData(this.dataArray);
      this.analysisWorker.postMessage(this.dataArray);
      requestAnimationFrame(process);
    };
    
    process();
  }

  detectSpeech({ energies }) {
    const sensitivity = document.getElementById('sensitivity').value;
    const prediction = this.recognizer.recognize(energies);
    
    if (prediction.score > sensitivity && !this.isSpeaking) {
      this.startSpeaking();
    } else if (prediction.score <= sensitivity && this.isSpeaking) {
      this.stopSpeaking();
    }
  }

  startSpeaking() {
    this.isSpeaking = true;
    this.avatar.children[0].morphTargetInfluences[this.morphTargets.mouthOpen] = 0.5;
  }

  stopSpeaking() {
    this.isSpeaking = false;
    this.avatar.children[0].morphTargetInfluences[this.morphTargets.mouthOpen] = 0;
  }

  updateVisuals({ frequencies }) {
    const now = Date.now();
    if (now - this.lastUpdate < 16) return;
    
    // Update progress ring
    const circle = document.getElementById('progressCircle');
    const circumference = 2 * Math.PI * 45;
    circle.style.strokeDasharray = `${circumference * this.currentVolume} ${circumference}`;

    // Update 3D model animation
    if (this.avatar) {
      this.avatar.rotation.y += 0.005;
      this.avatar.position.y = Math.sin(now * 0.002) * 0.1;
    }

    this.renderer.render(this.scene, this.camera);
    this.lastUpdate = now;
  }

  setupControls() {
    window.addEventListener('resize', () => {
      this.camera.aspect = window.innerWidth / window.innerHeight;
      this.camera.updateProjectionMatrix();
      this.renderer.setSize(window.innerWidth, window.innerHeight);
    });
  }
}

// Initialize with user interaction
document.addEventListener('click', async () => {
  const avatar = new VoiceAvatar();
  window.avatar = avatar; // For debugging
  document.getElementById('status').textContent = 'System Active';
});

// Web Worker code (audio-processor.js)
const workerCode = () => {
  self.onmessage = (event) => {
    const data = event.data;
    let sum = data.reduce((a, b) => a + b, 0);
    const volume = Math.min(1, sum / data.length / 255);
    
    const energies = Array.from({ length: 43 }, (_, i) => {
      const start = Math.floor(i * data.length / 43);
      const end = Math.floor((i + 1) * data.length / 43);
      return data.slice(start, end).reduce((a, b) => a + b, 0) / (end - start);
    });

    self.postMessage({ volume, energies });
  };
};

const blob = new Blob([`(${workerCode.toString()})()`], { type: 'text/javascript' });
const audioProcessorURL = URL.createObjectURL(blob);
</script>
</body>
</html>
