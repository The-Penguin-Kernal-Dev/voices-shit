<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voice Activated Avatar</title>
<style>
  body, html {
    margin: 0; 
    padding: 0; 
    height: 100%; 
    background: #111;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }

  .avatar-container {
    position: relative;
    width: min(90vmin, 600px);
    height: min(90vmin, 600px);
  }

  .avatar-image {
    position: absolute;
    width: 100%;
    height: 100%;
    object-fit: contain;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
  }

  .active {
    opacity: 1;
  }

  #permissionPrompt {
    position: fixed;
    top: 20px;
    color: white;
    background: #333;
    padding: 15px;
    border-radius: 8px;
    display: none;
  }
</style>
</head>
<body>
  <div class="avatar-container">
    <img id="idleAvatar" class="avatar-image active" src="https://i.ibb.co/chqZCvGC/idle.png" alt="Idle Avatar">
    <img id="talkingAvatar" class="avatar-image" src="https://i.ibb.co/Jw5PDXWp/talking.png" alt="Talking Avatar">
  </div>
  <div id="permissionPrompt">Click anywhere to enable microphone</div>

<script>
class VoiceAvatar {
  constructor() {
    this.idleImg = document.getElementById('idleAvatar');
    this.talkingImg = document.getElementById('talkingAvatar');
    this.permissionPrompt = document.getElementById('permissionPrompt');
    
    this.audioContext = null;
    this.analyser = null;
    this.isTalking = false;
    this.silentFrames = 0;
    
    this.init();
  }

  async init() {
    this.preloadImages();
    this.showPermissionPrompt();
    this.addEventListeners();
  }

  preloadImages() {
    new Image().src = this.idleImg.src;
    new Image().src = this.talkingImg.src;
  }

  showPermissionPrompt() {
    if (location.protocol === 'https:') {
      this.permissionPrompt.style.display = 'block';
    }
  }

  addEventListeners() {
    document.addEventListener('click', () => this.initializeAudio());
    window.addEventListener('beforeunload', () => this.cleanup());
  }

  async initializeAudio() {
    try {
      this.permissionPrompt.style.display = 'none';
      
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      this.setupAudioAnalysis(stream);
    } catch (error) {
      console.error('Audio access error:', error);
      this.permissionPrompt.textContent = 'Microphone access required - please refresh and allow access';
      this.permissionPrompt.style.display = 'block';
    }
  }

  setupAudioAnalysis(stream) {
    this.audioContext = new AudioContext();
    const source = this.audioContext.createMediaStreamSource(stream);
    
    this.analyser = this.audioContext.createAnalyser();
    this.analyser.fftSize = 2048;
    source.connect(this.analyser);
    
    this.startAnalysis();
  }

  startAnalysis() {
    const buffer = new Uint8Array(this.analyser.fftSize);
    let smoothedVolume = 0;
    
    const processAudio = () => {
      this.analyser.getByteTimeDomainData(buffer);
      
      // Calculate RMS volume
      const rms = Math.sqrt(
        buffer.reduce((acc, val) => acc + Math.pow(val - 128, 2), 0) / buffer.length
      ) / 128;

      // Apply exponential smoothing
      smoothedVolume = Math.max(rms, smoothedVolume * 0.85);
      
      this.updateAvatarState(smoothedVolume);
      requestAnimationFrame(processAudio);
    };

    processAudio();
  }

  updateAvatarState(volume) {
    const THRESHOLD = 0.04;
    const HYSTERESIS = 0.02;
    
    if (volume > THRESHOLD + HYSTERESIS && !this.isTalking) {
      this.setTalkingState(true);
    } else if (volume < THRESHOLD - HYSTERESIS && this.isTalking) {
      this.setTalkingState(false);
    }
  }

  setTalkingState(talking) {
    this.isTalking = talking;
    this.idleImg.classList.toggle('active', !talking);
    this.talkingImg.classList.toggle('active', talking);
  }

  cleanup() {
    if (this.audioContext) {
      this.audioContext.close();
    }
  }
}

// Initialize avatar when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  new VoiceAvatar();
});
</script>
</body>
</html>
